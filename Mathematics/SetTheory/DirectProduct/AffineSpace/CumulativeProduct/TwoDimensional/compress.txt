TE <TY U,TY ABELIAN_GROUP>CL AbstractTwoDimensionalCumulativeSum{PU:ABELIAN_GROUP m_M;int m_SZ_X;int m_SZ_Y;VE<VE<U>> m_a;AbstractTwoDimensionalCumulativeSum(ABELIAN_GROUP M,CRI SZ_X,CRI SZ_Y);AbstractTwoDimensionalCumulativeSum(ABELIAN_GROUP M,CO VE<VE<U>>& a ={});TE <TY...Args> IN VO Initialise(CO Args&... args);IN CO U& InitialRectangleSum(CRI i_x,CRI i_y)CO;IN U RectangleSum(CRI i_start_x,CRI i_start_y,CRI i_final_x,CRI i_final_y);};TE <TY ABELIAN_GROUP,TY...Args> AbstractTwoDimensionalCumulativeSum(ABELIAN_GROUP,CO Args&...)-> AbstractTwoDimensionalCumulativeSum<inner_t<ABELIAN_GROUP>,ABELIAN_GROUP>;TE <TY U = ll>CL TwoDimensionalCumulativeSum:PU AbstractTwoDimensionalCumulativeSum<U,AdditiveGroup<U>>{PU:IN TwoDimensionalCumulativeSum(CRI SZ_X,CRI SZ_Y);IN TwoDimensionalCumulativeSum(CO VE<VE<U>>& a ={});};
TE <TY U,TY ABELIAN_GROUP> IN AbstractTwoDimensionalCumulativeSum<U,ABELIAN_GROUP>::AbstractTwoDimensionalCumulativeSum(ABELIAN_GROUP M,CRI SZ_X,CRI SZ_Y):AbstractTwoDimensionalCumulativeSum(M,VE(SZ_X,VE(SZ_Y,M.Zero()))){}TE <TY U,TY ABELIAN_GROUP>AbstractTwoDimensionalCumulativeSum<U,ABELIAN_GROUP>::AbstractTwoDimensionalCumulativeSum(ABELIAN_GROUP M,CO VE<VE<U>>& a):m_M(MO(M)),m_SZ_X(a.SZ()),m_SZ_Y(),m_a(m_SZ_X + 1){ST_AS(! is_same<U,int>::value);CO U& zero = M.Zero();if(! a.empty()){m_SZ_Y = a[0].SZ();}m_a[0]= VE<U>(m_SZ_Y + 1,zero);for(int x = 0;x < m_SZ_X;x++){CO VE<U>& a_x = a[x];CO VE<U>& m_a_x_minus = m_a[x];VE<U>& m_a_x = m_a[x+1];m_a_x = VE<U>(m_SZ_Y + 1,zero);U temp = zero;for(int y = 0;y < m_SZ_Y;y++){m_a_x[y+1]= m_M.Sum(m_a_x_minus[y+1],temp = m_M.Sum(MO(temp),a_x[y]));}}}TE <TY U> IN TwoDimensionalCumulativeSum<U>::TwoDimensionalCumulativeSum(CRI SZ_X,CRI SZ_Y):TwoDimensionalCumulativeSum(VE(SZ_X,VE<U>(SZ_Y))){}TE <TY U> IN TwoDimensionalCumulativeSum<U>::TwoDimensionalCumulativeSum(CO VE<VE<U>>& a):AbstractTwoDimensionalCumulativeSum<U,AdditiveGroup<U>>(AdditiveGroup<U>(),a){}TE <TY U,TY ABELIAN_GROUP> TE <TY...Args> IN VO AbstractTwoDimensionalCumulativeSum<U,ABELIAN_GROUP>::Initialise(CO Args&... args){*TH = AbstractTwoDimensionalCumulativeSum<U,ABELIAN_GROUP>(MO(m_M),args...);}TE <TY U,TY ABELIAN_GROUP> IN CO U& AbstractTwoDimensionalCumulativeSum<U,ABELIAN_GROUP>::InitialRectangleSum(CRI i_x,CRI i_y)CO{AS(-1 <= i_x && i_x < m_SZ_X && -1 <= i_y && i_y < m_SZ_Y);RE m_a[i_x+1][i_y+1];}TE <TY U,TY ABELIAN_GROUP> IN U AbstractTwoDimensionalCumulativeSum<U,ABELIAN_GROUP>::RectangleSum(CRI i_start_x,CRI i_start_y,CRI i_final_x,CRI i_final_y){AS(0 <= i_start_x && i_start_x - 1 <= i_final_x && i_final_x < m_SZ_X && 0 <= i_start_y && i_start_y - 1 <= i_final_y && i_final_y < m_SZ_Y);RE m_M.Sum(m_M.Sum(m_a[i_start_x][i_start_y],m_M.Inverse(m_M.Sum(m_a[i_final_x+1][i_start_y],m_a[i_start_x][i_final_y+1]))),m_a[i_final_x+1][i_final_y+1]);}
